```{r}
library(tidyverse)
library(lubridate)
```

```{r, read_data, cache=TRUE}

accident <- read_csv("Motor_Vehicle_Collisions_-_Crashes.csv")
weather12_14 <- read_csv("noaa12_14.csv")
weather15_17 <- read_csv("noaa15_17.csv")
weather18_21 <- read_csv("noaa18_21.csv")
weather12_21 <- weather12_14 %>%
    add_row(weather15_17) %>%
    add_row(weather18_21)

# weather12_21 <- weather12_21 %>%
#     select(-c(ELEVATION, WSF5, WSF2, WESF, WESD, WDF5, WDF2, TSUN, TOBS, SNWD, PSUN, PGTM, MDSF, MDPR, DASF, DAPR, AWND)) %>%
#     mutate(DATE = ymd(DATE))

weather <- weather12_21 %>%
    select(!c(STATION, NAME, LATITUDE, LONGITUDE, ELEVATION)) %>%
    arrange(DATE) %>%
    group_by(DATE) %>%
    summarise(across(AWND:WT22, ~ mean(.x, na.rm = TRUE))) %>%
    replace(is.na(.), 0) %>%
    rename(
        Foggy = WT01,
        Heavy.Fog = WT02,
        Ice.Fog = WT22,
        Ground.Fog = WT21,
        Mist = WT13,
        Thunder = WT03,
        Small.Hail = WT04,
        Hail = WT05,
        Rime = WT06,
        Smoke = WT08,
        Blowing.Snow = WT09,
        Snow = WT18,
        Tornado = WT10,
        Damaging.Wind = WT11,
        Drizzle = WT14,
        Freezing.Drizzle = WT15,
        Rain = WT16,
        Unknown.Precipitation = WT19
    )
```

```{r test accuracy}
data <- mtcars
trainingAndTesting <- function(dataFrame, ratio) {
    dt <- sample(nrow(dataFrame), nrow(dataFrame) * ratio)
    train <- dataFrame[dt, ]
    test <- dataFrame[-dt, ]
    result <- list(train, test)
    return(result)
}

combined_set <- trainingAndTesting(data, ratio = 0.7)
train <- combined_set[[1]]
test <- combined_set[[2]]
testAccuracy <- function(fit.model, test, var.index, result.index) {
    num <- nrow(test)

    errors <- rep(NA, num)
    prediction <- predict(fit.model, newdata = test[var.index])

    for (i in 1:num) {
        errors[i] <- (prediction[i] - test[i, result.index])^2
    }

    return(mean(errors))
}

fit <- lm(data$wt ~ data$vs)
f <- testAccuracy(fit, train, test, 8)
f
```

```{r, data_cleaning, cache=TRUE}
accident <- accident %>%
    mutate(
        `CRASH DATE` = mdy(`CRASH DATE`)
    )

accident %>%
    summarize(
        `CRASH DATE min` = min(`CRASH DATE`),
        `CRASH DATE max` = max(`CRASH DATE`)
    )

accident %>%
    mutate(
        `CRASH MONTH` = month(`CRASH DATE`),
        `CRASH YEAR` = year(`CRASH DATE`)
    )

# weather12_21 <- weather12_21 %>%
#     group_by(DATE) %>%
#     summarise(
#         PRCP = mean(PRCP, na.rm = T),
#         SNOW = mean(SNOW, na.rm = T),
#         TMAX = mean(TMAX, na.rm = T),
#         TMIN = mean(TMIN, na.rm = T)
#     )
```

```{r}

```

```{r}
collisions_location <- accident %>%
    mutate(year = year(`CRASH DATE`)) %>%
    select("LATITUDE", "LONGITUDE", "year") %>%
    drop_na() %>%
    filter(LATITUDE != 0 & LONGITUDE != 0) %>%
    filter(year %in% c(2019, 2020, 2021))
collisions_location
```

# ```{r, include=F}
# ggplot(collisions_location, aes(x = LATITUDE, y = LONGITUDE)) +
#     geom_point(alpha = 0.01, size = 0.5, col = "darkgreen") +
#     ggtitle("Location of NYC Traffic Collision")
# ```

```{r}
accident_road <- accident %>%
    group_by(`ON STREET NAME`) %>%
    summarise(count = n())
```


```{r Time Separation}

accident <- accident %>%
    mutate(
        time_range = case_when(
            hour(`CRASH TIME`) < 4 ~ "Late Night",
            hour(`CRASH TIME`) < 8 ~ "Morning",
            hour(`CRASH TIME`) < 12 ~ "Midday",
            hour(`CRASH TIME`) < 16 ~ "Afternoon",
            hour(`CRASH TIME`) < 20 ~ "Evening",
            hour(`CRASH TIME`) < 24 ~ "Late Night"
        )
    )
```

```{r}

require(stringi)

accidents <- accident %>%
    select(`CRASH DATE`, `CRASH TIME`, `ON STREET NAME`, `CROSS STREET NAME`, `NUMBER OF PERSONS INJURED`, `NUMBER OF PERSONS KILLED`, `NUMBER OF PEDESTRIANS INJURED`, `NUMBER OF MOTORIST INJURED`, `CONTRIBUTING FACTOR VEHICLE 1`, `VEHICLE TYPE CODE 1`) %>%
    mutate(`CROSS STREET NAME` = case_when(is.na(`CROSS STREET NAME`) == TRUE ~ 0, TRUE ~ 1)) %>%
    drop_na() %>%
    mutate(
        `VEHICLE TYPE CODE 1` = tolower(`VEHICLE TYPE CODE 1`),
        `ON STREET NAME` = tolower(`ON STREET NAME`),
        `CONTRIBUTING FACTOR VEHICLE 1` = tolower(`CONTRIBUTING FACTOR VEHICLE 1`)
    ) %>%
    mutate(
        `VEHICLE TYPE CODE 1` = case_when(
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "sedan") ~ "sedan",
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "bus") ~ "bus",
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "wagon") ~ "wagon",
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "truck") ~ "truck",
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "bicycle") ~ "bicycle",
            T ~ "other"
        ),
        `CONTRIBUTING FACTOR VEHICLE 1` = case_when(
            stri_detect(`CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(fatigued/drowsy)|(fell asleep)"
            ) ~ "Fatigue",
            stri_detect(`CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "collision with pedestrian"
            ) ~ "Pedestrian",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex =
                    "(accelerator defective)|(brakes defective)|(oversized vehicle)|
(steering failure)|(tow hitch defective)|
(other lighting defects)|(headlights defective)|
(tinted windows)|(tire failure/inadequate)|(windshield inadequate)"
            ) ~ "Vehicle Defection",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(alchohol involvement)|(drugs (illegal))"
            ) ~ "Drug & Alcohol",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(failure to yield right of way)|(passing or lane usage improper)|(turning improperly)|(unsafe lane changing)|
(traffic control disregarded)|(unsafe speed)|(aggressive driving)|(failure to keep right)|(aggressive driving/road rage)"
            ) ~ "Disobey traffic rule",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(driver inattention/distraction)|(following too closely)|(backing unsafely)|(passing too closely)|
(outside car distraction)|(passneger distraction)|(eating or drinking)|(listening/using headphones)|(using on board navigation device)"
            ) ~ "Driver distraction",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(other vehicular)|(pavement slippery)|(reaction to uninvolved vehicle)|(pedestrian/bicyclist)|
(glare)|(obstruction/debris)|(pavement defective)|(reaction to other uninvolved vehicle)|(animals action)
|(lane marking improper)|(traffic control device improper)|(driverless/runaway vehicle)"
            ) ~ "Environmental (road, light, pedestrian)",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(lost consciousness)|(physical disability)|(illness)|(illnes)|(shoulder defective)",
            ) ~ "Driver Health Problem",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(prescription medication)|(driver inexperience)|(view obstructed)",
            ) ~ "force majeure of driver",
            T ~ "other"
        )
    ) %>%
    arrange(`CRASH DATE`)


accidents %>%
    group_by(`CONTRIBUTING FACTOR VEHICLE 1`) %>%
    summarise(
        death = mean(`NUMBER OF PERSONS KILLED`)
    )
```

# ```{r}
# public.transportation <- read_csv("publicTrans.csv")
# structure(public.transportation)
# public.transportation <- public.transportation %>%
#     mutate(
#         `CRASH DATE` = mdy(Date),
#         subway.ridership = as.numeric(`Subways: Total Estimated Ridership`),
#         bus.ridership = as.numeric(`Buses: Total Estimated Ridership`),
#         lirr.ridership = as.numeric(`LIRR: Total Estimated Ridership`),
#         metroNorth.ridership = as.numeric(`Metro-North: Total Estimated Ridership`),
#         total.public.ridership = subway.ridership + bus.ridership + lirr.ridership + metroNorth.ridership
#     ) %>%
#     filter(
#         `CRASH DATE` >= as.Date("2021-01-01")
#     ) %>%
#     select(`CRASH DATE`, subway.ridership, bus.ridership, lirr.ridership, metroNorth.ridership, total.public.ridership)

# # filter out 2021 statistics from `accidents`
# accident.2021 <- accident %>% # you can change accident into newly modified data frame
#     filter(
#         `CRASH DATE` >= as.Date("2021-01-01")
#     )

# # merge data
# accident.2021 <- accident.2021 %>%
#     left_join(public.transportation, by = "CRASH DATE") %>%
#     select(`CRASH DATE`, total.public.ridership, everything())
# ```


# ```{r}
# traffic_vol1 <- read_csv("Traffic_Volume12_13.csv")
# traffic_vol2 <- read_csv("Traffic_Volume14_19.csv")
# traffic_vol_full <- rbind(traffic_vol1, traffic_vol2)

# traffic <- traffic_vol_full %>%
#     mutate(Date = mdy(Date)) %>%
#     arrange(Date) %>%
#     select(!c(Direction, `Segment ID`, `ID`, `From`, `To`)) %>%
#     group_by(Date, `Roadway Name`) %>%
#     summarise(across(.fns = c(sum))) %>%
#     rename(`STREET NAME` = `Roadway Name`)
# ```


# ```{r}
# public.transportation <- read_csv("publicTrans.csv")
# structure(public.transportation)
# public.transportation <- public.transportation %>%
#   mutate(
#     `CRASH DATE` = mdy(Date),
#     subway.ridership = as.numeric(`Subways: Total Estimated Ridership`),
#     bus.ridership = as.numeric(`Buses: Total Estimated Ridership`),
#     lirr.ridership = as.numeric(`LIRR: Total Estimated Ridership`),
#     metroNorth.ridership = as.numeric(`Metro-North: Total Estimated Ridership`),
#     total.public.ridership = subway.ridership + bus.ridership + lirr.ridership + metroNorth.ridership
#   ) %>%
#   filter(
#     `CRASH DATE` >= as.Date("2021-01-01")
#   ) %>%
#   select(`CRASH DATE`, subway.ridership, bus.ridership, lirr.ridership, metroNorth.ridership, total.public.ridership)

# # filter out 2021 statistics from `accidents`
# accident.2021 <- accident %>% # you can change accident into newly modified data frame
#   filter(
#     `CRASH DATE` >= as.Date("2021-01-01")
#   )

# # merge data
# accident.2021 <- accident.2021 %>%
#   left_join(public.transportation, by = "CRASH DATE" ) %>%
#   select(`CRASH DATE`, total.public.ridership, everything())
# ```


```{r}
# trashcode
contributing_factor1 <- accident %>%
    mutate(
        `CONTRIBUTING FACTOR VEHICLE 1` =
            tolower(`CONTRIBUTING FACTOR VEHICLE 1`),
        `CONTRIBUTING FACTOR VEHICLE 1` =
            str_replace_all(
                `CONTRIBUTING FACTOR VEHICLE 1`, "illness*", "illness"
            )
    ) %>%
    group_by(`CONTRIBUTING FACTOR VEHICLE 1`) %>%
    summarise(count = n()) %>%
    filter(`CONTRIBUTING FACTOR VEHICLE 1` != 1 &
        `CONTRIBUTING FACTOR VEHICLE 1` != 80 &
        `CONTRIBUTING FACTOR VEHICLE 1` != "unspecified")

contributing_factor1
```

```{r Sunset, echo=FALSE, cache=TRUE}
sunset <- read_csv("sunset1.csv")
for (i in 2:12) {
    sunset <- sunset %>% add_row(read_csv(paste0("sunset", i, ".csv")))
}

sunset <- sunset %>%
    mutate(
        Day = paste("2020", str_replace(Day, "^.*,", "")),
        Date = ymd(Day),
        month = month(Date),
        day = day(Date)
    )

accidents <- accidents %>%
    mutate(
        month = month(`CRASH DATE`),
        day = day(`CRASH DATE`)
    ) %>%
    full_join(sunset, by = c("month", "day")) %>%
    mutate(
        hour = hour(`CRASH TIME`),
        minute = minute(`CRASH TIME`),
        Sunrise = hms(Sunrise),
        Sunset = hms(Sunset)
    ) %>%
    mutate(
        sunrise_hour = hour(Sunrise),
        sunrise_minute = minutes(Sunrise),
        sunset_hour = hour(Sunset),
        sunset_minute = minute(Sunset)
    ) %>%
    mutate(
        DayLight = ifelse(
            (hour >= sunrise_hour & hour < sunset_hour) |
                (hour == sunrise_hour & minute >= sunrise_minute) |
                (hour == sunset_hour & minute <= sunset_minute),
            1,
            0
        )
    )
```

```{r weather join}
accidents_full <- accidents %>%
    rename(DATE = `CRASH DATE`) %>%
    mutate(DATE = ymd(DATE)) %>%
    full_join(weather, by = "DATE")
```

```{r visualization}
accidents_full %>%
    summarise(
        `NoFog` = sum(ifelse((Foggy + Heavy.Fog + Smoke), 0, 1), na.rm = T) / n(),
        Fog = sum(Foggy, na.rm = T) / n(),
        HeavyFog = sum(Heavy.Fog, na.rm = T) / n(),
        Smoke = sum(Smoke, na.rm = T) / n(),
        IceFog = sum(Ice.Fog, na.rm = T) / n(),
    ) %>%
    pivot_longer(
        everything(),
        names_to = "Fog Type",
        values_to = "Proportion"
    ) %>%
    ggplot() +
    geom_col(aes(x = `Fog Type`, y = Proportion), fill = "steelblue") +
    theme_bw() +
    ggtitle("Proportion of Accidents by Fog Type")

accidents_full %>%
    filter(`NUMBER OF PERSONS INJURED` > 0) %>%
    summarise(
        `NoFog` = sum(ifelse(Foggy + Heavy.Fog + Smoke, 0, 1), na.rm = T) / n(),
        `Fog` = sum(Foggy, na.rm = T) / n(),
        `HeavyFog` = sum(Heavy.Fog, na.rm = T) / n(),
        `Smoke` = sum(Smoke, na.rm = T) / n(),
        `IceFog` = sum(Ice.Fog, na.rm = T) / n(),
    ) %>%
    pivot_longer(
        everything(),
        names_to = "Fog Type",
        values_to = "Proportion"
    ) %>%
    ggplot() +
    geom_col(
        aes(x = `Fog Type`, y = Proportion),
        fill = "steelblue", width = 0.5
    ) +
    theme_bw() +
    ggtitle("Proportion of Injury Accidents by Fog Type")


accidents_full %>%
    summarise(
        NoFog = mean(`NUMBER OF PERSONS INJURED` *
            (ifelse(Foggy + Heavy.Fog + Smoke, 0, 1)), na.rm = T),
        Fog = mean(`NUMBER OF PERSONS INJURED` * Foggy, na.rm = T),
        HeavyFog = mean(`NUMBER OF PERSONS INJURED` * Heavy.Fog, na.rm = T),
        Smoke = mean(`NUMBER OF PERSONS INJURED` * Smoke, na.rm = T),
        IceFog = mean(`NUMBER OF PERSONS INJURED` * Ice.Fog, na.rm = T)
    ) %>%
    pivot_longer(
        everything(),
        names_to = "Fog Type",
        values_to = "mean_injury"
    ) %>%
    ggplot(aes(`Fog Type`, mean_injury)) +
    geom_col(fill = "steelblue", width = 0.5) +
    xlab("Fog Type") +
    ylab("Mean Injury (Base on degree of fog)") +
    theme_bw() +
    ggtitle("Mean Injury by Fog Type")

accidents_full %>%
    filter(`NUMBER OF PERSONS INJURED` > 5) %>%
    group_by(DayLight) %>%
    summarise(
        DayLight = as.factor(DayLight),
        injury = `NUMBER OF PERSONS INJURED`
    ) %>%
    drop_na() %>%
    ggplot(aes(DayLight, injury)) +
    ylab("Injury") +
    geom_boxplot() +
    ggtitle("Box Plot of Injury by Daylight (Injury Number > 5)")


accidents_full %>%
    mutate(
        prcp_range = case_when(
            PRCP == 0 | is.na(PRCP) ~ "No Rain",
            PRCP < 0.4 ~ "Light Rain",
            PRCP < 1.0 ~ "Moderate Rain",
            PRCP < 2.0 ~ "Heavy Rain",
            PRCP < 4.0 ~ "Very Heavy Rain",
            PRCP < 10.0 ~ "Extreme Rain",
            T ~ "Super Extreme Rain"
        )
    ) %>%
    group_by(prcp_range) %>%
    summarise(injury = mean(`NUMBER OF PERSONS INJURED`, na.rm = T)) %>%
    ggplot(
        aes(x = `prcp_range`, y = injury)
    ) +
    xlab("Precipitation Level") +
    ylab("Injury") +
    geom_col(fill = "steelblue")


(accidents_full) %>%
    mutate(
        snow_range = case_when(
            SNOW == 0 | is.na(SNOW) ~ "No Snow",
            SNOW < 0.4 * 13 ~ "Light Snow",
            SNOW < 1.0 * 13 ~ "Moderate Snow",
            SNOW < 2.0 * 13 ~ "Heavy Snow",
            SNOW < 4.0 * 13 ~ "Very Heavy Snow",
            SNOW < 10.0 * 13 ~ "Extreme Snow",
            T ~ "Super Extreme Snow"
        )
    ) %>%
    group_by(snow_range) %>%
    summarise(injury = mean(`NUMBER OF PERSONS INJURED`, na.rm = T)) %>%
    ggplot(
        aes(x = `snow_range`, y = injury)
    ) +
    xlab("Snow Level") +
    ylab("Injury") +
    geom_col(fill = "steelblue")

(accidents_full[sample(nrow(accidents_full), 5000), ]) %>%
    ggplot(aes(PRCP, `NUMBER OF PERSONS INJURED`)) +
    geom_point()
```

```{r model}

trainingAndTestingSet <- trainingAndTesting(accidents_full, ratio = 0.7)
trainingAndTestingSet

lm1 <- lm(
    `NUMBER OF PERSONS INJURED` ~ Foggy * Heavy.Fog + Smoke +
        `VEHICLE TYPE CODE 1` + TMAX + TMIN +
        `CONTRIBUTING FACTOR VEHICLE 1` + PRCP + SNOW + Ice.Fog + DayLight,
    data = (trainingAndTestingSet[[1]])
)

lm2 <- glm(
    I(`NUMBER OF PERSONS INJURED` > 0) ~ Foggy + Heavy.Fog + Smoke + `VEHICLE TYPE CODE 1` +
        TMAX + TMIN + `CONTRIBUTING FACTOR VEHICLE 1` + PRCP + SNOW + DayLight,
    data = trainingAndTestingSet[[1]],
    family = "binomial"
)

summary(lm1)

summary(lm2)
```

```{r}
testAccuracy(lm2, trainingAndTestingSet[[2]], colnames(trainingAndTestingSet[[1]], "NUMBER OF PERSONS INJURED"))

mean(
    (trainingAndTestingSet[[2]]$`NUMBER OF PERSONS INJURED` > 0) == (predict(lm2,
        newdata = trainingAndTestingSet[[2]],
        type = "response"
    ) > 0.25),
    na.rm = T
)
```