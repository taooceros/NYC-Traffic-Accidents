```{r}
library(tidyverse)
library(lubridate)

```

```{r, read_data, cache=TRUE}

accident <- read_csv("Motor_Vehicle_Collisions_-_Crashes.csv")
weather12_14 <- read_csv("noaa12_14.csv")
weather15_17 <- read_csv("noaa15_17.csv")
weather18_21 <- read_csv("noaa18_21.csv")
weather12_21 <- weather12_14 %>%
    add_row(weather15_17) %>%
    add_row(weather18_21)

# weather12_21 <- weather12_21 %>%
#     select(-c(ELEVATION, WSF5, WSF2, WESF, WESD, WDF5, WDF2, TSUN, TOBS, SNWD, PSUN, PGTM, MDSF, MDPR, DASF, DAPR, AWND)) %>%
#     mutate(DATE = ymd(DATE))

weather<-weather12_21%>%
    select(!c(STATION, NAME, LATITUDE, LONGITUDE, ELEVATION)) %>% 
    arrange(DATE) %>% 
    group_by(DATE)%>%
    summarise(across(AWND:WT22, ~ mean(.x, na.rm = TRUE))) %>% 
    replace(is.na(.), 0)
```

```{r test accuracy}
data <- mtcars;

trainingAndTesting <- function(dataFrame, ratio) {
  dt = sample(nrow(data), nrow(data) * ratio);
  train <- data[dt,];
  test <- data[-dt,];
  result <-list(train, test);
  return(result)
}

combined_set <- trainingAndTesting(data, ratio = 0.7)
train <- combined_set[[1]];
test <- combined_set[[2]];
```

```{r, data_cleaning, cache=TRUE}
accident <- accident %>%
    mutate(
        `CRASH DATE` = mdy(`CRASH DATE`)
    )

accident %>%
    summarize(
        `CRASH DATE min` = min(`CRASH DATE`),
        `CRASH DATE max` = max(`CRASH DATE`)
    )

accident %>%
    mutate(
        `CRASH MONTH` = month(`CRASH DATE`),
        `CRASH YEAR` = year(`CRASH DATE`)
    )

# weather12_21 <- weather12_21 %>%
#     group_by(DATE) %>%
#     summarise(
#         PRCP = mean(PRCP, na.rm = T),
#         SNOW = mean(SNOW, na.rm = T),
#         TMAX = mean(TMAX, na.rm = T),
#         TMIN = mean(TMIN, na.rm = T)
#     )
```

```{r}
accident_full <- accident %>%
    rename(DATE = `CRASH DATE`) %>%
    inner_join(weather, by = "DATE") %>% 
    arrange(DATE)

accident_full
```

```{r}
collisions_location <- accident %>%
    mutate(year = year(`CRASH DATE`)) %>%
    select("LATITUDE", "LONGITUDE", "year") %>%
    drop_na() %>%
    filter(LATITUDE != 0 & LONGITUDE != 0) %>%
    filter(year %in% c(2019, 2020, 2021))
collisions_location
```

```{r, include=F}
ggplot(collisions_location, aes(x = LATITUDE, y = LONGITUDE)) +
    geom_point(alpha = 0.01, size = 0.5, col = "darkgreen") +
    ggtitle("Location of NYC Traffic Collision")
```

```{r}
accident_road <- accident %>%
    group_by(`ON STREET NAME`) %>%
    summarise(count = n())
```

```{r}
require(stringi)

require(stringi)

accidents <- accident %>%
    select(`CRASH DATE`, `CRASH TIME`, `ON STREET NAME`, `NUMBER OF PERSONS INJURED`, `NUMBER OF PERSONS KILLED`, `NUMBER OF PEDESTRIANS INJURED`, `NUMBER OF MOTORIST INJURED`, `CONTRIBUTING FACTOR VEHICLE 1`, `VEHICLE TYPE CODE 1`) %>%
    drop_na() %>%
    mutate(
        `VEHICLE TYPE CODE 1` = tolower(`VEHICLE TYPE CODE 1`),
        `ON STREET NAME` = tolower(`ON STREET NAME`),
        `CONTRIBUTING FACTOR VEHICLE 1` = tolower(`CONTRIBUTING FACTOR VEHICLE 1`)
    ) %>%
    mutate(
        `VEHICLE TYPE CODE 1` = case_when(
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "sedan") ~ "sadan",
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "bus") ~ "bus",
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "wagon") ~ "wagon",
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "truck") ~ "truck",
            stri_detect(`VEHICLE TYPE CODE 1`, fixed = "bicycle") ~ "bicycle",
            T ~ "other"
        ),
        `CONTRIBUTING FACTOR VEHICLE 1` = case_when(
            stri_detect(`CONTRIBUTING FACTOR VEHICLE 1`, regex = "(fatigued/drowsy)|(fell asleep)") ~ "Fatigue",
            stri_detect(`CONTRIBUTING FACTOR VEHICLE 1`, regex = "collision with pedestrian") ~ "Pedestrian",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(accelerator defective)|(brakes defective)|(oversized vehicle)|(steering failure)|(tow hitch defective)|(other lighting defects)|(headlights defective)|(tinted windows)|(tire failure/inadequate)|(windshield inadequate)"
            ) ~ "Vehicle Defection",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(alchohol involvement)|(drugs (illegal))"
            ) ~ "Drug & Alcohol",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(failure to yield right of way)|(passing or lane usage improper)|(turning improperly)|(unsafe lane changing)|(traffic control disregarded)|(unsafe speed)|(aggressive driving)|(failure to keep right)|(aggressive driving/road rage)"
            ) ~ "Disobey traffic rule",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(driver inattention/distraction)|(following too closely)|(backing unsafely)|(passing too closely)|(outside car distraction)|(passneger distraction)|(eating or drinking)|(listening/using headphones)|(using on board navigation device)"
            ) ~ "Driver distraction",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(other vehicular)|(pavement slippery)|(reaction to uninvolved vehicle)|(pedestrian/bicyclist)|(glare)|(obstruction/debris)|(pavement defective)|(reaction to other uninvolved vehicle)|(animals action)|(lane marking improper)|(traffic control device improper)|(driverless/runaway vehicle)"
            ) ~ "Environmental (road, light, pedestrian)",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(lost consciousness)|(physical disability)|(illness)|(illnes)|(shoulder defective)",
            ) ~ "Driver Health Problem",
            stri_detect(
                `CONTRIBUTING FACTOR VEHICLE 1`,
                regex = "(prescription medication)|(driver inexperience)|(view obstructed)",
            ) ~ "force majeure of driver",
            T ~ "other"
        )
    ) %>%
    arrange(`CRASH DATE`)


accidents %>%
    group_by(`CONTRIBUTING FACTOR VEHICLE 1`) %>%
    summarise(
        death = mean(`NUMBER OF PERSONS KILLED`)
    )


# mutate(
#     `VEHICLE TYPE CODE 1` = tolower(`VEHICLE TYPE CODE 1`),
#     `ON STREET NAME` = tolower(`ON STREET NAME`),
#     `VEHICLE TYPE CODE 1` = str_replace_all(`VEHICLE TYPE CODE 1`, ".*sedan.*", "sedan"),
#     `VEHICLE TYPE CODE 1` = str_replace_all(`VEHICLE TYPE CODE 1`, ".*bus.*", "bus"),
#     `VEHICLE TYPE CODE 1` = str_replace_all(`VEHICLE TYPE CODE 1`, ".*wagon.*", "wagon"),
#     `VEHICLE TYPE CODE 1` = str_replace_all(`VEHICLE TYPE CODE 1`, ".*truck.*", "truck"),
#     `VEHICLE TYPE CODE 1` = str_replace_all(`VEHICLE TYPE CODE 1`, ".*bicycle.*", "bike"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*cell phone.*", "electronic devices"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*electronic.*", "electronic devices"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*headphone.*", "electronic devices"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*navigation device.*", "electronic devices"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*texting.*", "electronic devices"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*fatigue.*", "fatigue"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*sleep.*", "fatigue"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*vihecle vendalism.*", "vihecle defection"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*windshield inadequate.*", "vihecle defection"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*tire failure/inadequate.*", "vihecle defection"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*tinted windows.*", "vihecle defection"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*headlights defective.*", "vihecle defection"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*brakes defective.*", "vihecle defection"),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, ".*accelerator defective.*", "vihecle defection")
# ) %>%
# filter(`VEHICLE TYPE CODE 1` %in% accident$`VEHICLE TYPE CODE 1`) %>%
# mutate(
#     `CONTRIBUTING FACTOR VEHICLE 1` = tolower(`CONTRIBUTING FACTOR VEHICLE 1`),
#     `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, "illness*", "illness")
# ) %>%
# filter(`CONTRIBUTING FACTOR VEHICLE 1` != 1 & `CONTRIBUTING FACTOR VEHICLE 1` != 80 & `CONTRIBUTING FACTOR VEHICLE 1` != "unspecified") %>%
# mutate(`CRASH HOUR` = hour(strptime(`CRASH TIME`, "%H:%M")))
```

```{r}
public.transportation <- read_csv("publicTrans.csv")
structure(public.transportation)
public.transportation <- public.transportation %>%
    mutate(
        `CRASH DATE` = mdy(Date),
        subway.ridership = as.numeric(`Subways: Total Estimated Ridership`),
        bus.ridership = as.numeric(`Buses: Total Estimated Ridership`),
        lirr.ridership = as.numeric(`LIRR: Total Estimated Ridership`),
        metroNorth.ridership = as.numeric(`Metro-North: Total Estimated Ridership`),
        total.public.ridership = subway.ridership + bus.ridership + lirr.ridership + metroNorth.ridership
    ) %>%
    filter(
        `CRASH DATE` >= as.Date("2021-01-01")
    ) %>%
    select(`CRASH DATE`, subway.ridership, bus.ridership, lirr.ridership, metroNorth.ridership, total.public.ridership)

# filter out 2021 statistics from `accidents`
accident.2021 <- accident %>% # you can change accident into newly modified data frame
    filter(
        `CRASH DATE` >= as.Date("2021-01-01")
    )

# merge data
accident.2021 <- accident.2021 %>%
    left_join(public.transportation, by = "CRASH DATE") %>%
    select(`CRASH DATE`, total.public.ridership, everything())
```


```{r}
traffic_vol1 <- read_csv("Traffic_Volume12_13.csv")
traffic_vol2 <- read_csv("Traffic_Volume14_19.csv")
traffic_vol_full <- rbind(traffic_vol1, traffic_vol2)

traffic <- traffic_vol_full %>%
    mutate(Date = mdy(Date)) %>%
    arrange(Date) %>%
    select(!c(Direction, `Segment ID`, `ID`, `From`, `To`)) %>%
    group_by(Date, `Roadway Name`) %>%
    summarise(across(.fns = c(sum))) %>% 
    rename(`STREET NAME` = `Roadway Name`)
```


```{r}
public.transportation <- read_csv("publicTrans.csv")
structure(public.transportation)
public.transportation <- public.transportation %>%
  mutate(
    `CRASH DATE` = mdy(Date),
    subway.ridership = as.numeric(`Subways: Total Estimated Ridership`),
    bus.ridership = as.numeric(`Buses: Total Estimated Ridership`),
    lirr.ridership = as.numeric(`LIRR: Total Estimated Ridership`),
    metroNorth.ridership = as.numeric(`Metro-North: Total Estimated Ridership`),
    total.public.ridership = subway.ridership + bus.ridership + lirr.ridership + metroNorth.ridership
  ) %>%
  filter(
    `CRASH DATE` >= as.Date("2021-01-01")
  ) %>%
  select(`CRASH DATE`, subway.ridership, bus.ridership, lirr.ridership, metroNorth.ridership, total.public.ridership)

# filter out 2021 statistics from `accidents`
accident.2021 <- accident %>% # you can change accident into newly modified data frame
  filter(
    `CRASH DATE` >= as.Date("2021-01-01")
  )

# merge data
accident.2021 <- accident.2021 %>%
  left_join(public.transportation, by = "CRASH DATE" ) %>%
  select(`CRASH DATE`, total.public.ridership, everything())
```


```{r}
# trashcode
contributing_factor1 <- accident %>%
    mutate(
        `CONTRIBUTING FACTOR VEHICLE 1` = tolower(`CONTRIBUTING FACTOR VEHICLE 1`),
        `CONTRIBUTING FACTOR VEHICLE 1` = str_replace_all(`CONTRIBUTING FACTOR VEHICLE 1`, "illness*", "illness")
    ) %>%
    group_by(`CONTRIBUTING FACTOR VEHICLE 1`) %>%
    summarise(count = n()) %>%
    filter(`CONTRIBUTING FACTOR VEHICLE 1` != 1 & `CONTRIBUTING FACTOR VEHICLE 1` != 80 & `CONTRIBUTING FACTOR VEHICLE 1` != "unspecified")

contributing_factor1
```


```{r Time Separation}

accident <- accident %>%
    mutate(
        time_range = case_when(
            hours(`CRASH TIME`) < 4 ~ "Late Night",
            hours(`CRASH TIME`) < 8 ~ "Morning",
            hours(`CRASH TIME`) < 12 ~ "Midday",
            hours(`CRASH TIME`) < 16 ~ "Afternoon",
            hours(`CRASH TIME`) < 20 ~ "Evening",
            hours(`CRASH TIME`) < 24 ~ "Late Night"
        )
    )
```

```{r TimeRange Analysis}

accident %>%
    group_by(time_range, `CONTRIBUTING FACTOR 1`) %>%
    summarise(count = n()) %>%
    arrange(desc(count))
```