```{r}
library(tidyverse)
library(lubridate)
```

```{r, read_data, cache=TRUE}

set.seed(203741092)
truck_type1 <- read_csv("truck_type-1.csv") %>%
    rename(type1 = type)
truck_type2 <- read_csv("truck_type-2.csv") %>%
    rename(type2 = type)
truck_type3 <- read_csv("truck_type-3.csv") %>%
    rename(type3 = type)
truck_type4 <- read_csv("truck_type-4.csv") %>%
    rename(type4 = type)
truck_type5 <- read_csv("truck_type-5.csv") %>%
    rename(type5 = type)
accident <- read_csv("Motor_Vehicle_Collisions_-_Crashes.csv") %>%
    left_join(truck_type1, by = "COLLISION_ID") %>%
    left_join(truck_type2, by = "COLLISION_ID") %>%
    left_join(truck_type3, by = "COLLISION_ID") %>%
    left_join(truck_type4, by = "COLLISION_ID") %>%
    left_join(truck_type5, by = "COLLISION_ID") %>%
    select(-c(`VEHICLE TYPE CODE 1`, `VEHICLE TYPE CODE 2`, `VEHICLE TYPE CODE 3`, `VEHICLE TYPE CODE 4`, `VEHICLE TYPE CODE 5`)) %>%
    rename(
        `VEHICLE TYPE CODE 1` = type1,
        `VEHICLE TYPE CODE 2` = type2,
        `VEHICLE TYPE CODE 3` = type3,
        `VEHICLE TYPE CODE 4` = type4,
        `VEHICLE TYPE CODE 5` = type5
    )

weather12_14 <- read_csv("noaa12_14.csv")
weather15_17 <- read_csv("noaa15_17.csv")
weather18_21 <- read_csv("noaa18_21.csv")
weather12_21 <- weather12_14 %>%
    add_row(weather15_17) %>%
    add_row(weather18_21)


weather <- weather12_21 %>%
    select(!c(STATION, NAME, ELEVATION)) %>%
    arrange(DATE) %>%
    group_by(DATE) %>%
    summarise(across(AWND:WT22, ~ mean(as.numeric(.x), na.rm = TRUE))) %>%
    replace(is.na(.), 0) %>%
    rename(
        Foggy = WT01,
        Heavy.Fog = WT02,
        Ice.Fog = WT22,
        Ground.Fog = WT21,
        Mist = WT13,
        Thunder = WT03,
        Small.Hail = WT04,
        Hail = WT05,
        Rime = WT06,
        Smoke = WT08,
        Blowing.Snow = WT09,
        Snow = WT18,
        Tornado = WT10,
        Damaging.Wind = WT11,
        Drizzle = WT14,
        Freezing.Drizzle = WT15,
        Rain = WT16,
        Unknown.Precipitation = WT19
    )
```

```{r na analysis}
t.test(
    (accident %>% filter(!is.na(`BOROUGH`)))$`NUMBER OF PERSONS INJURED`,
    (accident %>% filter(is.na(`BOROUGH`)))$`NUMBER OF PERSONS INJURED`
)
```



```{r test accuracy}
data <- mtcars
trainingAndTesting <- function(dataFrame, ratio) {
    dt <- sample(nrow(dataFrame), nrow(dataFrame) * ratio)
    train <- dataFrame[dt, ]
    test <- dataFrame[-dt, ]
    result <- list(train, test)
    return(result)
}

combined_set <- trainingAndTesting(data, ratio = 0.7)
train <- combined_set[[1]]
test <- combined_set[[2]]
testAccuracy <- function(fit.model, test, var.index, result.index) {
    num <- nrow(test)

    errors <- rep(NA, num)
    prediction <- predict(fit.model, newdata = test[var.index])

    for (i in 1:num) {
        errors[i] <- (prediction[i] - test[i, result.index])^2
    }

    return(mean(errors))
}
```

```{r, data_cleaning, cache=TRUE}
accident <- accident %>%
    mutate(
        `CRASH DATE` = mdy(`CRASH DATE`)
    )

accident %>%
    summarize(
        `CRASH DATE min` = min(`CRASH DATE`),
        `CRASH DATE max` = max(`CRASH DATE`)
    )

accident %>%
    mutate(
        `CRASH MONTH` = month(`CRASH DATE`),
        `CRASH YEAR` = year(`CRASH DATE`)
    )
```

```{r}
collisions_location <- accident %>%
    mutate(year = year(`CRASH DATE`)) %>%
    select("LATITUDE", "LONGITUDE", "year") %>%
    drop_na() %>%
    filter(LATITUDE != 0 & LONGITUDE != 0) %>%
    filter(year %in% c(2019, 2020, 2021))
collisions_location
```

```{r}
accident_road <- accident %>%
    group_by(`ON STREET NAME`) %>%
    summarise(count = n())
```


```{r Time Separation}

accident <- accident %>%
    mutate(
        time_range = case_when(
            hour(`CRASH TIME`) < 4 ~ "Late Night",
            hour(`CRASH TIME`) < 8 ~ "Morning",
            hour(`CRASH TIME`) < 12 ~ "Midday",
            hour(`CRASH TIME`) < 16 ~ "Afternoon",
            hour(`CRASH TIME`) < 20 ~ "Evening",
            hour(`CRASH TIME`) < 24 ~ "Late Night"
        )
    )
```


```{r Sunset, echo=FALSE, cache=TRUE}
sunset <- read_csv("sunset1.csv")
for (i in 2:12) {
    sunset <- sunset %>% add_row(read_csv(paste0("sunset", i, ".csv")))
}

sunset <- sunset %>%
    mutate(
        Day = paste("2020", str_replace(Day, "^.*,", "")),
        Date = ymd(Day),
        month = month(Date),
        day = day(Date)
    )

accidents <- accident %>%
    mutate(
        month = month(`CRASH DATE`),
        day = day(`CRASH DATE`)
    ) %>%
    full_join(sunset, by = c("month", "day")) %>%
    mutate(
        hour = hour(`CRASH TIME`),
        minute = minute(`CRASH TIME`),
        Sunrise = hms(Sunrise),
        Sunset = hms(Sunset)
    ) %>%
    mutate(
        sunrise_hour = hour(Sunrise),
        sunrise_minute = minutes(Sunrise),
        sunset_hour = hour(Sunset),
        sunset_minute = minute(Sunset)
    ) %>%
    mutate(
        DayLight = ifelse(
            (hour >= sunrise_hour & hour < sunset_hour) |
                (hour == sunrise_hour & minute >= sunrise_minute) |
                (hour == sunset_hour & minute <= sunset_minute),
            1,
            0
        )
    )
```
1. 40.788193, -73.937672
2. 40.778374, -73.860884
3. 40.711646, -73.976068
4. 40.712806, -73.827198

1. 40.778374, -73.937672
2. 40.778374, -73.860884
3. 40.712806, -73.976068
4. 40.712806, -73.827198

```{r Location Separation}

accidents <- accidents %>%
    mutate(
        LOCATION_SPLIT = case_when(
            LATITUDE > 40.778374 ~ case_when(
                LONGITUDE < -73.937672 ~ "0",
                LONGITUDE < -73.860884 ~ "1",
                T ~ "2",
            ),
            LATITUDE > 40.712806 ~ case_when(
                LONGITUDE < -73.976068 ~ "3",
                LONGITUDE < -73.827198 ~ "4",
                T ~ "5",
            ),
            T ~ case_when(
                LONGITUDE < -73.976068 ~ "6",
                LONGITUDE < -73.827198 ~ "7",
                T ~ "8",
            )
        )
    )
```


```{r weather join}
accidents_full <- accidents %>%
    rename(DATE = `CRASH DATE`) %>%
    mutate(DATE = ymd(DATE)) %>%
    rename("CROSS STREET" = "CROSS STREET NAME") %>%
    full_join(weather, by = "DATE")

accidents_full <- accidents_full %>%
    mutate(
        SNOW = ifelse(is.na(SNOW), 0, SNOW),
        PRCP = ifelse(is.na(PRCP), 0, PRCP),
        TMAX = ifelse(is.na(TMAX), 0, TMAX),
        TMIN = ifelse(is.na(TMIN), 0, TMIN),
        Foggy = ifelse(is.na(Foggy), 0, Foggy)
    )
```

```{r visualization}
accidents_full %>%
    summarise(
        `NoFog` = sum(ifelse((Foggy + Heavy.Fog + Smoke), 0, 1), na.rm = T) / n(),
        Fog = sum(Foggy, na.rm = T) / n(),
        HeavyFog = sum(Heavy.Fog, na.rm = T) / n(),
        Smoke = sum(Smoke, na.rm = T) / n(),
        IceFog = sum(Ice.Fog, na.rm = T) / n(),
    ) %>%
    pivot_longer(
        everything(),
        names_to = "Fog Type",
        values_to = "Proportion"
    ) %>%
    ggplot() +
    geom_col(aes(x = `Fog Type`, y = Proportion), fill = "steelblue") +
    theme_bw() +
    ggtitle("Proportion of Accidents by Fog Type")

accidents_full %>%
    filter(`NUMBER OF PERSONS INJURED` > 0) %>%
    summarise(
        `NoFog` = sum(ifelse(Foggy + Heavy.Fog + Smoke, 0, 1), na.rm = T) / n(),
        `Fog` = sum(Foggy, na.rm = T) / n(),
        `HeavyFog` = sum(Heavy.Fog, na.rm = T) / n(),
        `Smoke` = sum(Smoke, na.rm = T) / n(),
        `IceFog` = sum(Ice.Fog, na.rm = T) / n(),
    ) %>%
    pivot_longer(
        everything(),
        names_to = "Fog Type",
        values_to = "Proportion"
    ) %>%
    ggplot() +
    geom_col(
        aes(x = `Fog Type`, y = Proportion),
        fill = "steelblue", width = 0.5
    ) +
    theme_bw() +
    ggtitle("Proportion of Injury Accidents by Fog Type")


accidents_full %>%
    summarise(
        NoFog = mean(`NUMBER OF PERSONS INJURED` *
            (ifelse(Foggy + Heavy.Fog + Smoke, 0, 1)), na.rm = T),
        Fog = mean(`NUMBER OF PERSONS INJURED` * Foggy, na.rm = T),
        HeavyFog = mean(`NUMBER OF PERSONS INJURED` * Heavy.Fog, na.rm = T),
        Smoke = mean(`NUMBER OF PERSONS INJURED` * Smoke, na.rm = T),
        IceFog = mean(`NUMBER OF PERSONS INJURED` * Ice.Fog, na.rm = T)
    ) %>%
    pivot_longer(
        everything(),
        names_to = "Fog Type",
        values_to = "mean_injury"
    ) %>%
    ggplot(aes(`Fog Type`, mean_injury)) +
    geom_col(fill = "steelblue", width = 0.5) +
    xlab("Fog Type") +
    ylab("Mean Injury (Base on degree of fog)") +
    theme_bw() +
    ggtitle("Mean Injury by Fog Type")

accidents_full %>%
    filter(`NUMBER OF PERSONS INJURED` > 5) %>%
    group_by(DayLight) %>%
    summarise(
        DayLight = as.factor(DayLight),
        injury = `NUMBER OF PERSONS INJURED`
    ) %>%
    drop_na() %>%
    ggplot(aes(DayLight, injury)) +
    ylab("Injury") +
    geom_boxplot() +
    ggtitle("Box Plot of Injury by Daylight (Injury Number > 5)")


accidents_full %>%
    mutate(
        prcp_range = case_when(
            PRCP == 0 | is.na(PRCP) ~ "No Rain",
            PRCP < 0.4 ~ "Light Rain",
            PRCP < 1.0 ~ "Moderate Rain",
            PRCP < 2.0 ~ "Heavy Rain",
            PRCP < 4.0 ~ "Very Heavy Rain",
            PRCP < 10.0 ~ "Extreme Rain",
            T ~ "Super Extreme Rain"
        )
    ) %>%
    group_by(prcp_range) %>%
    summarise(injury = mean(`NUMBER OF PERSONS INJURED`, na.rm = T)) %>%
    ggplot(
        aes(x = `prcp_range`, y = injury)
    ) +
    xlab("Precipitation Level") +
    ylab("Injury") +
    geom_col(fill = "steelblue")


(accidents_full) %>%
    mutate(
        snow_range = case_when(
            SNOW == 0 | is.na(SNOW) ~ "No Snow",
            SNOW < 0.4 * 13 ~ "Light Snow",
            SNOW < 1.0 * 13 ~ "Moderate Snow",
            SNOW < 2.0 * 13 ~ "Heavy Snow",
            SNOW < 4.0 * 13 ~ "Very Heavy Snow",
            SNOW < 10.0 * 13 ~ "Extreme Snow",
            T ~ "Super Extreme Snow"
        )
    ) %>%
    group_by(snow_range) %>%
    summarise(injury = mean(`NUMBER OF PERSONS INJURED`, na.rm = T)) %>%
    ggplot(
        aes(x = `snow_range`, y = injury)
    ) +
    xlab("Snow Level") +
    ylab("Injury") +
    geom_col(fill = "steelblue")

(accidents_full[sample(nrow(accidents_full), 5000), ]) %>%
    ggplot(aes(PRCP, `NUMBER OF PERSONS INJURED`)) +
    geom_point()

```

```{r}
accidents_full <- accidents_full %>%
    mutate(
        truck_involved = (
            (`VEHICLE TYPE CODE 1` == "Truck") |
                (`VEHICLE TYPE CODE 2` == "Truck") |
                (`VEHICLE TYPE CODE 3` == "Truck") |
                (`VEHICLE TYPE CODE 4` == "Truck") |
                (`VEHICLE TYPE CODE 5` == "Truck")
        ),
        two_wheel_involved = (
            (`VEHICLE TYPE CODE 1` %in% c("Bike", "Motor")) |
                (`VEHICLE TYPE CODE 2` %in% c("Bike", "Motor")) |
                (`VEHICLE TYPE CODE 3` %in% c("Bike", "Motor")) |
                (`VEHICLE TYPE CODE 4` %in% c("Bike", "Motor")) |
                (`VEHICLE TYPE CODE 5` %in% c("Bike", "Motor"))
        )
    ) %>%
    mutate(
        at_crossing = !is.na(`CROSS STREET`)
    )
```


```{r model}
# seperate trainning data and testing data
af <- accidents_full %>%
    select(`NUMBER OF PERSONS INJURED`,`LONGITUDE`, `LATITUDE`, Foggy, Smoke, Heavy.Fog, `VEHICLE TYPE CODE 1`, PRCP, SNOW, Ice.Fog, DayLight, `BOROUGH`, `LOCATION_SPLIT`, at_crossing, two_wheel_involved, truck_involved) %>%
    drop_na()
set.seed(123)

rows <- sample(nrow(af)) # Randomly reorder the row of the dataset.
train_num <- as.integer(length(rows) * 0.8) # Separating the dataset to two parts, one for training the model, and the other for testing the model.
test_num <- train_num + 1
len <- nrow(af %>% drop_na())

train_df <- af[rows, ][1:train_num, ]
test_df <- af[rows, ][test_num:len, ]

# generate model
lm_1 <- glm(
    (`NUMBER OF PERSONS INJURED` > 0) ~ Foggy + Smoke + Heavy.Fog + `VEHICLE TYPE CODE 1` + PRCP + SNOW + Ice.Fog + DayLight + `BOROUGH` + `LOCATION_SPLIT` + at_crossing + two_wheel_involved + truck_involved,
    data = (train_df),
    family = "binomial"
)

test_df <- test_df %>% mutate(status = case_when(`NUMBER OF PERSONS INJURED` > 0 ~ 1, TRUE ~ 0))

probabilities <- predict(lm_1, type = "response", newdata = test_df)
predictions <- ifelse(probabilities > 0.5, 1, 0)
sum(predictions == test_df$status)
sum(predictions == 1)
sum(predictions & test_df$status)
sum(test_df$status == 1)
```


```{r accident location mean}

samples <- sample(nrow(train_df), 150000)

train_df[samples, ] %>%
    filter(`LONGITUDE` != 0 & `LATITUDE` != 0) %>%
    ggplot() +
    geom_point(
        aes(
            x = `LATITUDE`, y = `LONGITUDE`, size = (`NUMBER OF PERSONS INJURED`^3) / 10,
            color = `NUMBER OF PERSONS INJURED` > 0
        ),
        alpha = 0.1
    )
```

```{r randomForest}
library(randomForest)

af2 <- accidents_full %>%
    select(Foggy, Smoke, Heavy.Fog, `VEHICLE TYPE CODE 1`, TMAX, TMIN, `CONTRIBUTING FACTOR VEHICLE 1`, PRCP, SNOW, Ice.Fog, DayLight, vehicle, `BOROUGH`, `LOCATION_SPLIT`, `CROSS STREET`, `NUMBER OF PERSONS INJURED`, `LATITUDE`, `LONGITUDE`) %>%
    drop_na()

sampleIndex <- sample(nrow(af), 25000)

af2 <- af2 %>%
    rename(
        `vehicle_type_code_1` = `VEHICLE TYPE CODE 1`,
        `contributing_factor_vehicle_1` = `CONTRIBUTING FACTOR VEHICLE 1`,
        `cross` = `CROSS STREET`
    )

r1 <- randomForest(
    as.factor(`NUMBER OF PERSONS INJURED` > 0) ~ LATITUDE + LONGITUDE,
    mtry = 1,
    data = af2,
    subset = sampleIndex,
    ntree = 1000
)


sample2Index <- sample(nrow(af2), 50000)

injury_position2 <- predict(r1, newdata = af2[sample2Index, ], type = "response")

tibble(
    mark = injury_position2,
    LONGITUDE = af2[sample2Index, ]$LONGITUDE,
    LATITUDE = af2[sample2Index, ]$LATITUDE
) %>%
    ggplot(aes(x = `LATITUDE`, y = `LONGITUDE`, color = mark)) +
    geom_point(aes(
        alpha =
            ifelse(mark == "TRUE", 0.5, 0.1)
    ))
```

```{r}

trainingAndTestingSet <- trainingAndTesting(accidents_full, ratio = 0.7)
trainingAndTestingSet

lm1 <- lm(
    `NUMBER OF PERSONS INJURED` ~ Foggy * Heavy.Fog + Smoke +
        `VEHICLE TYPE CODE 1` + TMAX + TMIN +
        `CONTRIBUTING FACTOR VEHICLE 1` + PRCP + SNOW + Ice.Fog + DayLight,
    data = (trainingAndTestingSet[[1]])
)

lm2 <- glm(
    (`NUMBER OF PERSONS INJURED` > 0) ~ Foggy + Smoke +
        `VEHICLE TYPE CODE 1` + `CONTRIBUTING FACTOR VEHICLE 1` +
        PRCP + SNOW + DayLight + `BOROUGH`,
    data = trainingAndTestingSet[[1]],
    family = "binomial"
)

lm3 <- glm(
    `NUMBER OF PERSONS INJURED` ~ Foggy + Smoke +
        `VEHICLE TYPE CODE 1` + `CONTRIBUTING FACTOR VEHICLE 1` +
        PRCP + SNOW + DayLight + `BOROUGH` + `LOCATION_SPLIT`,
    data = (
        ((trainingAndTestingSet[[1]] %>%
            drop_na(
                Foggy, Heavy.Fog, Smoke,
                `VEHICLE TYPE CODE 1`,
                `CONTRIBUTING FACTOR VEHICLE 1`,
                PRCP, SNOW, DayLight
            )))),
    family = "poisson"
)

summary(lm1)

summary(lm2)

summary(lm3)
```

```{r}
mean(
    (trainingAndTestingSet[[2]]$`NUMBER OF PERSONS INJURED` > 0) == (predict(lm2,
        newdata = trainingAndTestingSet[[2]],
        type = "response"
    ) > 0.5),
    na.rm = T
)

test.predict <- (tibble(injury = (predict(lm3,
    newdata = trainingAndTestingSet[[2]], type = "response"
) > 0.5)) %>% drop_na())$injury

test.actual <- (
    ((trainingAndTestingSet[[2]] %>%
        drop_na(
            Foggy, Heavy.Fog, Smoke,
            `VEHICLE TYPE CODE 1`,
            `CONTRIBUTING FACTOR VEHICLE 1`,
            PRCP, SNOW, DayLight
        ))
    ["NUMBER OF PERSONS INJURED"]) > 0)


quantile(predict(lm2, type = "response"), na.rm = FALSE, names = TRUE)
quantile(accidents_full$`NUMBER OF PERSONS INJURED`, na.rm = T)


tibble(
    Type = c("Injury", "No Injury"),
    Prediction = c(
        (sum(test.predict, na.rm = T)),
        (sum(!test.predict, na.rm = T))
    ),
    Actual = c(
        sum(
            test.actual,
            na.rm = T
        ),
        sum(
            !test.actual,
            na.rm = T
        )
    ),
    Accuracy = c(
        sum(
            (test.actual & test.predict),
            na.rm = T
        ) / sum(test.actual),
        sum(
            (!test.actual & !test.predict),
            na.rm = T
        ) / sum(!test.actual)
    )
)
```





